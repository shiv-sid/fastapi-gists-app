# File: k8s/all-manifests.yml
# Combined Kubernetes manifests for FastAPI Gists Application with Monitoring
# Created: November 9, 2025

#---------------------------------------
# Source: k8s/deployment.yml
# Description: Main application deployment
#---------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-gists-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fastapi-gists-app
  template:
    metadata:
      labels:
        app: fastapi-gists-app
    spec:
      containers:
        - name: fastapi-gists-container
          image: shivsid/fastapi-gists-app:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080

          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10

          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20

          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"
---
#---------------------------------------
# Source: k8s/service-clusterip.yml
# Description: Internal ClusterIP service
#---------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: fastapi-gists-service
spec:
  selector:
    app: fastapi-gists-app
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8080
---
#---------------------------------------
# Source: k8s/ingress.yml
# Description: Main application ingress
#---------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fastapi-gists-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$1
spec:
  ingressClassName: nginx
  rules:
    - host: fastapi.gists.local
      http:
        paths:
          - path: /(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: fastapi-gists-service
                port:
                  number: 80
---
#---------------------------------------
# Source: k8s/service-loadbalancer.yml
# Description: LoadBalancer service (alternative)
#---------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: fastapi-gists-service-lb
spec:
  selector:
    app: fastapi-gists-app
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
---
#---------------------------------------
# Source: k8s/service.yml
# Description: NodePort service (alternative)
#---------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: fastapi-gists-service-nodeport
spec:
  type: NodePort
  selector:
    app: fastapi-gists-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      nodePort: 30080
---
#---------------------------------------
# Source: k8s/monitoring-manifests.yml
# Description: Monitoring stack configuration
#---------------------------------------
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
apiVersion: helm.sh/v3
kind: HelmRelease
metadata:
  name: prometheus
  namespace: monitoring
spec:
  chart:
    repository: https://prometheus-community.github.io/helm-charts
    name: prometheus
    version: 19.9.0
  values:
    alertmanager:
      persistentVolume:
        enabled: false
    server:
      persistentVolume:
        enabled: false
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:10.0.0
          ports:
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  type: ClusterIP
  selector:
    app: grafana
  ports:
    - port: 80
      targetPort: 3000
---
#---------------------------------------
# Source: k8s/grafana-ingress.yml
# Description: Grafana monitoring UI access
#---------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: grafana.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 80
---
#---------------------------------------
# Source: k8s/monitoring-manifests.yml
# Description: Prometheus monitoring UI access
#---------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: prometheus.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus-server
                port:
                  number: 80
---
#---------------------------------------
# Source: k8s/grafana-values.yml
# Description: Helm values for Grafana (included for reference)
#---------------------------------------
# grafana-values.yml
service:
  type: ClusterIP
  port: 80

ingress:
  enabled: true
  ingressClassName: nginx
  hosts:
    - host: grafana.local
      paths:
        - path: /
          pathType: Prefix

adminUser: admin
adminPassword: admin

persistence:
  enabled: false

resources:
  requests:
    memory: "128Mi"